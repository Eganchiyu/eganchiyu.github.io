---
title: SSH的工作原理
excerpt: SSH是如何运作的？

categories: 
  -  学习记录

tags:
  -  博客
  -  记录

comments: true
entries_layout: grid

# header:
#     teaser: 

---

# 前言

这篇文章介绍了SSH的基本工作原理，列出了可能有用的参考资料，专业性可能会偏强，但我会在保留学术严谨表达的同时，使用通俗语气，让文章不会显得太过难以理解。

说不定会插入几张美图，毕竟学习很辛苦，营造归属感是很重要的

![](/assets/images/2025-12-14-11-36-41.png)

毕竟，总体来说，SSH的工作流本来就不难，是很容易理解的。接下来我会尝试以自己的话解释SSH的完整工作逻辑

---

-はい！　始まるよ~

# SSH的定义

![](/assets/images/2026-01-26-14-51-59.png)

~~SSH是主要应用于肿瘤研究的用于基因差异表达分析的实验方法~~

不对，什么鬼

SSH（Secure Shell），**安全外壳协议**，[是一种加密的网络传输协议](https://zhuanlan.zhihu.com/p/235610836)

作为一种协议，SSH存在多种实现，包括**商业**和**开源实现**（OSSH，OpenSSH）

SSH的核心在于，如何在完全不加密的网络通道上，建立起**绝对安全的加密会话**

# SSH的通信原理

SSH的通信认证过程主要分为两个阶段：**密钥交换**和**身份认证**

## 第一阶段：密钥交换(Key Exchange / Handshake)

密钥交换后，可以根据 **双方共有** 且 **仅双方共有** 的数据，来加密信息流

所以如何获取**符合要求的共享密钥**是关键

### 1. 版本协商（明文传输）

SSH有很多版本，不同设备支持的版本可能不同，需要先进行**版本协商**，确定双方**都能接受的版本方案**

具体操作如下：

1. **服务器端监听**
   - 服务器开放 TCP 端口 22，**等待客户端连接**

2. **客户端发起连接**
   - 客户端向服务器端发起 **TCP 初始连接请求**

3. **服务器发送版本标识**
     - 服务器向客户端发送**第一个报文**，包含**版本标志字符串**，格式为：  
     ```
     SSH-<主协议版本号>.<次协议版本号>.<软件版本号>
     ```
      - 其中，协议版本号 = 主版本号 + 次版本号，软件版本号主要用于调试和实现标识

4. **客户端解析并选择协议版本**
     - 若服务器协议版本**低于客户端版本**，且客户端**支持**该低版本，则采用**服务器端协议版本**；
     - 否则，使用**客户端自身的协议版本**。

5. **客户端回应版本号**
   - 客户端向服务器发送报文，告知最终选定的协议版本号。

6. **服务器确认协商结果**
    - 若协商成功，进入**密钥交换与算法协商阶段**；
    - 若协商失败，服务器直接断开 TCP 连接。

---

参考资料：

具体数据字节可以参考[这篇博客](https://www.cnblogs.com/dier-gaohe/p/16971894.html)，解释的非常清楚

具体流程如下，参考了[这篇博客](https://blog.csdn.net/m0_56763594/article/details/127390391)：

### 2. 算法协商

双方交换支持的加密算法列表（如 Ed25519, AES-GCM 等），并选择最优解

1. 服务器端与客户端分别向对端发送**算法协商报文**。  
   报文中包含**各自支持**的：
   - 公钥算法列表  
   - 对称加密算法列表  
   - MAC（Message Authentication Code，消息验证码）算法列表  
   - 压缩算法列表等。

2. 服务器端与客户端根据**双方支持算法的交集**，协商并确定最终使用的算法组合。

---

参考文献：[RHCE 作业2](https://blog.csdn.net/m0_56763594/article/details/127390391)

### 3. 生成共享密钥

这里就是魔法的发生点，是涉及**数学**和**密码学原理**的核心

服务器端与客户端通过 **Diffie–Hellman（DH）密钥交换**，结合主机密钥对等参数，生成：
   - 会话密钥（Session Key）  
   - 会话 ID（Session ID）

```
Diffie-Hellman密钥交换流程:
参数选择 → 密钥生成 → 公共值交换 → 共享密钥计算
```

---

具体的DH密钥交换操作主要是由 **模幂运算** 实现的

#### 3.1 数学方式

* 运算技术： 模运算
* 安全性基础： 离散对数问题

基本流程：

1. 约定参数：双方约定两个大质数 $g$（生成元）和 $p$（大质数模数）（均公开）
2. 私有选择：亚澄选择一个随机大整数 $a$ 作为私钥；妃爱选择一个随机大整数 $b$ 作为私钥
3. 计算并交换公钥：亚澄计算 $A = g^a \bmod p$，发送给妃爱；妃爱计算 $B = g^b \bmod p$，发送给亚澄
4. 算出共享密钥 (K)：亚澄计算 $K = B^a \bmod p$；妃爱计算 $K = A^b \bmod p$。

根据数学交换律：

$$K = (g^b \bmod p)^a \bmod p = (g^a \bmod p)^b \bmod p = g^{ab} \bmod p$$

所以最后可以得出相等的密钥，且根据离散对数问题，仅由$g$、$p$、$A$、$B$是很难直接推出各自的私钥$a$、$b$，并进而很难推出会话的密钥$K$

![](/assets/images/2026-01-26-17-01-16.png)

---

参考文献：[OSChina：SSH传输层协议](https://my.oschina.net/lowkey2046/blog/710823)、[Tencent：Diffie-Hellman密钥交换技术解析](https://cloud.tencent.com/developer/article/2590429)

图源引用自：[一文搞懂Diffie-Hellman密钥交换协议](https://zhuanlan.zhihu.com/p/599518034)

---

#### 3.2 直观解释

基本流程：

1. 双方公开选择一种底色（如**蓝色**）
2. 亚澄随机选取一个只有自己知道的颜色（**绿色**）；妃爱机选取一种只有自己知道的颜色（**红色**）
3. 亚澄把**公共蓝色**和**绿色**（得到**青色**）混合；妃爱**公共蓝色**和**红色**（得到**紫色**）混合，互相交换颜色
4. 亚澄拿到**紫色**，再和**绿色**混合；妃爱拿到**青色**，再和**红色**混合，两者都获得了一模一样的**神秘深褐色**

虽然第三方拿到了紫色和青色，但是也无法分离出红色和绿色

#### 3.3 共享密钥的前向安全性

得到的共享密钥K仅在**单次会话**中有效，所以即使私钥泄露，也**不会造成历史通信流量泄露**

#### 3.4 Diffie-Hellman的中间人攻击模式

攻击者截获计算得到的A和B，而是向亚澄和妃爱两者**分别发送自己的C1，C2**

这样就会在自己和亚澄、妃爱两者之间分别建立安全连接，而亚澄和妃爱都不知道通信被截获，信息劫持成功

### 结语

至此，双方获得相同的会话密钥和会话 ID。后续数据传输均使用该会话密钥进行加密与解密，以保证通信安全


## 第二阶段： 身份认证：挑战-响应机制

现在，我们已经有了一段安全的‘悄悄话通道’（对称加密）

但妃爱还得确认，对面坐着的真的是亚澄，而不是伪装成亚澄的黑客。

具体过程：

1. 发送钥匙 ID： 亚澄告诉妃爱“我想用指纹为 SHA256:... 的这把钥匙登录。”

2. 检查名单：妃爱在账户设置（Settings -> SSH keys）里查找。如果找到了匹配的公钥，它会**生成一个随机数（Challenge）**。

3. 加密挑战：妃爱用你的公钥对这个随机数进行加密，然后发给亚澄。公钥加密的东西，**只有对应的私钥能解开**。

4. 解密与签名：亚澄收到密文，动用保存在 ~/.ssh/id_ed25519 的私钥将其解开。

5. 为了证明自己确实解开了，亚澄会将解出的随机数加上当前会话的 ID，再用私钥进行数字签名（Signature），发回给妃爱

6. 最终验证：妃爱**用公钥验证这个签名**。如果签名有效，说明亚澄确实持有私钥。

![](/assets/images/2026-01-26-17-06-38.png)

---

数学背景：

* 核心概念：陷门函数
* RSA加密：基于大数分解
* ECC（椭圆曲线算法）：基于几何轨迹

由于技术比较成熟，而且网络文献比较多，我就不详细介绍了，可以去B站或者Bing查

可以参阅这篇文章：[椭圆曲线加密算法（ECC）](https://zhuanlan.zhihu.com/p/101907402)

图源引用自：[知乎：SSH 密钥身份验证和管理](https://zhuanlan.zhihu.com/p/676228728)

## 后期通信

在获得共享密钥$K$之后，后期信息流都是通过加密算法**加密传输**的

目前最主流、最安全的对称加密算法是 **AES（高级加密标准）**，可以参考 [知乎：高级加密标准（AES）](https://zhuanlan.zhihu.com/p/360393988)

在 SSH 连接中，通常配合 GCM（伽罗瓦/计数器模式） 或 ChaCha20-Poly1305 使用。它的特点是：**加密和解密用的是同一个密钥 $K$**

---

加密传输过程：

1. 分组与填充：数据被**切成固定大小的数据块**。如果最后一块不够大，会填入一些随机数。
2. “异或”运算与置换：将数据块和密钥$K$进行一次**异或运算**，再进行**字节代换**和**行移位**、**列混淆**生成密文
3. 解密：只需要使用共享密钥$K$进行**反向操作**即可

数据的加密传输过程中，加密和解密的速度都是非常快的，能保证数据传输的效率

AES 如此之快，是因为现代 CPU（包括树莓派 4B 搭载的 ARM 处理器）通常都有**专门的硬件指令集**来**加速这些逻辑运算**，它不像 RSA 那样需要消耗大量 CPU 周期去算大数的幂次方

> 至此，SSH通信的基本原理和流程就讲清楚了。我们可以使用现成的OpenSSH进行各种远程信息传输了（虽然其实没搞懂也能轻松使用SSH就是了，不过能搞懂原理总是对使用有利无害）

# 结语

辛苦读了这么久文章，现在起身去活动一下吧。一直坐在电脑桌前总是对身体不好的。

身体是革命的本钱。搞好身体才能用现有技术去创造全新的技术，并更好地服务大众。

作为知识的拓荒者，要深入到生活中，或者工业、军事、国际等，去了解，到底现在需要什么，然后看准了就不怕麻烦、有节奏地去做好

作为百姓，我们也不能因为技术的发展而完全依赖。要开动自己的脑子，去做更多有意义的事情。作为人类，有意义的事情莫过于和重要的人一起待着，去给世界提供更多的感动，去为自己和重要的人创造更多美好的回忆，让这一生至少值得被自己记住

所以，想一想吧，现在开始，能做些什么，让你的今天变得值得回忆呢？

去外面走走，去邂逅猫猫狗狗，去和家人逛街，精心准备礼物，用相机镜头记录下一切，或者是听歌、唱歌

这个世界很简单，简单到人与人的沟通其实不需要通讯加密。但是好多人都忘记了。网络梗、没必要的博弈在包装着情感。当然，这也是有必要的，只不过应该在需要用它的时候再启用。

如果找到了心有灵犀的伙伴，就把公钥给他一份，然后创造一个安全通信空间，用真心对待和珍惜

![](/assets/images/2026-01-26-17-10-58.png)

---

接下来我会记录在**笔记本与树莓派**、**树莓派与github之间**的**SSH认证和通信**的过程，写成一篇新的博客，敬请期待！

<span title = '你知道的太多了' class = 'heimu'>附：会有一些我折腾词典笔的珍贵记录</span>